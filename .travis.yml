language: ruby

sudo: required

services: docker

script: 
    - cd backend
    # - docker-compose -f local-docker-compose.yml build
    # - docker-compose -f local-docker-compose.yml up -d
    - echo "no tests"
    - sed -i -e 's/\r$/\n/' start.sh
    - sed -i -e 's/\r$/\n/' stop.sh
    - sed -i -e 's/\r$/\n/' install.sh #correct files endings
    - zip -r latest *
    - mkdir -p dpl_cd_upload
    - mv latest.zip dpl_cd_upload/latest.zip
    
after_success:
    - docker --version
    - pip install --user awscli #instala el cliente de aws
    - export PATH=$PATH:$HOME/.local/bin # pone aws en el path 
    - eval $(aws ecr get-login --region us-east2 --no-include-email) #necesita AWS_ACCESS_KEY_ID y AWS_SECRET_ACCESS_KEY envars
    - docker build -t $AWS_ECR_API:latest api
    - docker tag $AWS_ECR_API:latest
    - docker push $AWS_ECR_API:latest
    - docker images
    
deploy:
    provider: s3
    access_key_id: $AWS_ACCESS_KEY_ID
    secret_access_key: $AWS_SECRET_ACCESS_KEY
    local_dir: dpl_cd_upload
    skip_cleanup: true 
    bucket: "16arqsis-travis-s3"
    region: us-east-2 
    upload-dir: latest
    provider: codedeploy
    access_key_id: $AWS_ACCESS_KEY_ID
    secret_access_key: $AWS_SECRET_ACCESS_KEY
    bucket: "16arqsis-travis-s3"
    key: latest/latest.zip
    bundle_type: zip
    application: 16v2-travis
    deployment_group: 16v2-travis-staging
    region: us-east-2
    wait_until_deployed: true
    on:
        branch: travis2